####################
out of shared memory
####################
1) maintenance_work_mem = 256MB (когда расчётное 512MB)
проблема связана с дублированием выделения памяти для обработки worker-ов, в качестве компенсационной меры предлагается уменьшить параметры, отвечающие за выделение
памяти на процессы в 2 раза
2) Если разовое уменьшение не помогает, продолжать уменьшать до момента отсутствия ошибки.
Для информации
•
work mem,
Если в системе есть сложные запросы требующие сортировки (а они наверняка есть:) то под каждый из них выделяется work_mem * «количество сортировок в системе, на текущий момент> (MB).
T.е. объём памяти в work mem MB выделяется на КАЖДЫй сложный запрос с сортировкой в системе!
Мало того, при выполнении параллельных рабочих процессов, которые могут запускаются одним узлом, выделяется объём памяти размером work mem*max_parallel workers per gather (MB).
T.е при выполнении запроса с несколькими параллельными подзапросами будет выделено work mem MB памяти на КАЖдый параллельно выполняющийся подзапрос.
•
maintenance_work_mem
При каждом выполнении операций CREATE INDEX, VACUUM, ALTER TABLE ADD FOREIGN KEY выделяется объем памяти размером maintenance work_mem (MB).
Причём, для операции VACUUM выделяется объём памяти размером maintenance_wark_mem (MB) autovacuum_max workers рaз.

####################
Распухание директории с wal файлами
####################
Действия при заполнении ф.с. файлами WAL(журналы упреждающей записи).
В случае остутствия места в ф.с. с архивными WAL , журналы продолжают записываться в основную директорию pg_xlog до заполнения ф.с.
План действий: 
1 При срабатывании мониторинга необходимо запустить инкрементальную сессию забора WAL файлов.
(Даже в случае отсутствия места в ф.с. с архивными журналами , запись журналов продолжается в директорию где размещены логи(SPGDATA)-посмотреть можно в postgresql.conf, до ее заполнения)
Несжатые архивные журналы имеют размер 16Мб.
Проверить лог на сообщение о битых архивных WAL в логе $PGDATA/pg_log , можно использовать команду ниже.Выполнить:
./profile
Выполнить команду
cat $(find $PGDATA/pg_log/-name postgresql* -mtime -1 | sort -r | head -n 1)|grep "WARNING: archiving transaction log'|tail -1>log.del
Если такой архив есть, то удалить его.
Посмотреть где лежет архивы
cat $(find $PGDATA/ -name postgresql*) | grep 'archive_command'
a) Архивные логи забранные на ленты можно удалить.
b) Архивные логи можно перенаправить в другую директорию.
Для этого в postgresql.conf необходимо изменить параметр archive_command
1. archive_command = 'test ! -f/dbdata/archivedir/9.5/log/logs/%f && cp %p /dbdata/archivedir/9.5/log/logs/%f'
изменить пути на новую директорию
2. выполнить переконфигурацию командой pg_ctl reload -- перезапустит СУБД
Сообщить СРК ,в конфигурации сессий резервирования необходимо изменить пути забора логов.
Для проверки переключения логов используется команда  pg_switch_xlog().
Восстановление - процесс применения WAI после последнего checkpoint

####################
Не удаляются архивные журналы WAL при резервном копировании
####################
Сокращается свободное место в файловой системе, на которую указывает команда архивации WAL в параметре archive_command.

Параметр сервера archive_command выглядит обычным образом, например:
postgres = show archive command :
archive_command: pg probackup-11 archive-push -B /pgarclogs/11 - instance - compress batch siza=100

В логе сервера нет ошибок выполеннеия команд архивации
• Причины
Настройки скриптов резервного копирования VAL 11_pg_se_archlogs.sh, 11_manage_backup.sh - неполнеы не верные,  не соответствуют настройкам в команде архивации экземпляра.
Используемые скрипты находятся в директории /opt/omni/1bin того сервера, с которого снимается копия.
Настройки в команде архивации WAL не совпадают с настройками скриптов. В примере:
Команда архивации: -B /pgarclogs/11 --instance uvski_prom-55bd1o.
Скрипт 11_pg_se_archlogs.sh:
BACKUP_DIR="/backup/11"
PGINSTANCE="uvski_prom-55bdlo"
Wallstate_FILE=Backup_DIR/walls_to_delete
sOME_ARChIVE_ABSENT=0
SoME_aRCHIVE_WAS_NOT_REmoved=0
INVALID PATH=0
LOG File
fILE=Backup
DIR/archive.

